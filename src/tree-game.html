<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»ç’ƒæ©‹æŒ‘æˆ° - Binary Search Tree</title>
    <style>
        :root {
            --squid-pink: #ff1493;
            --squid-cyan: #00d9ff;
            --squid-dark: #0a0a0a;
            --squid-green: #00ff41;
            --glass-color: rgba(0, 217, 255, 0.15);
            --glass-border: var(--squid-cyan);
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--squid-dark);
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }
        .playground-container {
            display: grid;
            grid-template-columns: 350px 1fr 350px;
            height: 100vh;
        }

        /* å…±ç”¨æ¨£å¼ */
        .sidebar, .tasks-panel {
            background: linear-gradient(135deg, #1a2d2d 0%, #0a1a1a 100%);
            border-right: 3px solid var(--squid-cyan);
            overflow-y: auto;
            padding: 2rem 1rem;
        }
        .tasks-panel {
            border-right: none;
            border-left: 3px solid var(--squid-cyan);
        }
        .tutorial-box, .status-box, .history-box {
            background: rgba(0, 217, 255, 0.1);
            border: 2px solid var(--squid-cyan);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .tasks-panel h3, .tutorial-box h3 {
            color: var(--squid-cyan);
            margin-bottom: 1rem;
        }
        .tutorial-box p {
            line-height: 1.8;
            color: #ddd;
        }
        .tutorial-box strong {
            color: var(--squid-green);
        }
        .back-button {
            position: absolute; top: 1rem; left: 1rem; background: rgba(0, 217, 255, 0.2);
            border: 2px solid var(--squid-cyan); color: var(--squid-cyan); width: 45px; height: 45px;
            border-radius: 50%; cursor: pointer; font-size: 1.3rem; text-decoration: none;
            display: flex; align-items: center; justify-content: center; z-index: 10; transition: all 0.3s;
        }
        .back-button:hover { background: var(--squid-cyan); color: #000; }

        /* ä¸­é–“éŠæˆ²å€ */
        .game-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 2rem;
        }
        .game-header {
            width: 100%;
            text-align: center;
        }
        .game-header h1 { color: var(--squid-cyan); font-size: 2.5rem; }
        .game-header p { color: #aaa; font-size: 1.2rem; }
        .target-box {
            background: var(--squid-dark);
            border: 3px solid var(--squid-pink);
            padding: 1rem 2rem;
            border-radius: 15px;
            font-size: 2rem;
            box-shadow: 0 0 20px var(--squid-pink);
        }
        .target-box span { color: var(--squid-pink); font-weight: bold; }

        /* ç»ç’ƒæ©‹éŠæˆ²å€ */
        .tree-container {
            width: 100%;
            height: 60vh;
            position: relative;
        }
        .tree-node {
            position: absolute;
            background: var(--glass-color);
            border: 2px solid var(--glass-border);
            border-radius: 10px;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            transition: all 0.3s;
        }
        .tree-node.current {
            border-color: var(--squid-green);
            box-shadow: 0 0 20px var(--squid-green);
            background: rgba(0, 255, 65, 0.3);
            transform: scale(1.1);
        }
        /* â–¼â–¼â–¼ æ–°å¢æ¨£å¼ â–¼â–¼â–¼ */
        .tree-node.clickable {
            cursor: pointer;
        }
        .tree-node.clickable:hover {
            border-color: var(--squid-pink);
            box-shadow: 0 0 20px var(--squid-pink);
            background: rgba(255, 20, 147, 0.3);
        }
        /* â–²â–²â–² æ–°å¢æ¨£å¼ â–²â–²â–² */
        .tree-node.path {
            background: rgba(0, 255, 65, 0.5);
        }
        .tree-node.broken {
            animation: broken-glass 0.5s forwards;
        }
        @keyframes broken-glass {
            to { opacity: 0; transform: translateY(50px) rotate(30deg) scale(0.5); }
        }
        .tree-line {
            position: absolute;
            background: var(--glass-border);
            transform-origin: 0 0;
            z-index: -1;
        }

        #start-btn {
            background: var(--squid-pink); color: #000; border: none; padding: 1rem 2rem;
            font-size: 1.2rem; font-weight: bold; border-radius: 25px; cursor: pointer; transition: all 0.2s;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7);
            display: flex; align-items: center; justify-content: center; z-index: 100; display: none;
        }
        .modal-content {
            background: var(--squid-dark); padding: 3rem; border-radius: 20px;
            text-align: center;
        }
        #end-game-modal .modal-content {
            border: 3px solid var(--squid-pink); box-shadow: 0 0 40px var(--squid-pink);
        }
        #end-game-modal h2 { font-size: 2.5rem; color: var(--squid-pink); margin-bottom: 1rem; }
        #end-game-modal p { font-size: 1.5rem; margin-bottom: 2rem; }
        #end-game-modal .final-score { color: var(--squid-cyan); font-weight: bold; font-size: 2rem; }
        .modal-buttons { display: flex; gap: 1rem; }
        .modal-buttons .btn {
            flex: 1; padding: 0.8rem 1.5rem; font-size: 1rem; text-decoration: none;
            display: inline-block; line-height: 1.5; border: none; cursor: pointer; border-radius: 12px;
        }
        .btn-replay { background: var(--squid-green); color: #000; }
        .btn-next { background: var(--squid-cyan); color: #000; }
    </style>
</head>
<body>
<div class="playground-container">
    <!-- å·¦å´ï¼šæ•™å­¸ -->
    <div class="sidebar">
        <a href="index.html" class="back-button" title="è¿”å›ä¸»é¸å–®">ğŸ </a>
        <div class="tutorial-box" style="margin-top: 4rem;">
            <h3>ğŸ“– éŠæˆ²è¦å‰‡</h3>
            <p><strong>1. å°‹æ‰¾ç›®æ¨™</strong><br>è¨˜ä½ç•«é¢ä¸­å¤®çš„ã€Œç›®æ¨™è™Ÿç¢¼ã€ã€‚</p>
            <p><strong>2. é¸æ“‡è·¯å¾‘</strong><br>ä½¿ç”¨<strong>æ»‘é¼ é»æ“Š</strong>ï¼Œæˆ–ç”¨éµç›¤çš„ <strong>â†</strong> å’Œ <strong>â†’</strong> æ–¹å‘éµä¾†é¸æ“‡è·¯å¾‘ã€‚å¦‚æœç›®æ¨™è™Ÿç¢¼æ¯”ç•¶å‰æ•¸å­—<strong>å°</strong>ï¼Œå°±å¾€<strong>å·¦</strong>ï¼›å¦‚æœ<strong>å¤§</strong>ï¼Œå°±å¾€<strong>å³</strong>ã€‚</p>
            <p><strong>3. å°å¿ƒç»ç’ƒï¼</strong><br>é¸éŒ¯äº†ç»ç’ƒæ¿ï¼Œå®ƒå°±æœƒç¢è£‚ï¼ŒæŒ‘æˆ°å¤±æ•—ï¼</p>
        </div>
        <div class="tutorial-box">
            <h3>ğŸ’¡ å­¸ç¿’é‡é»: Binary Search Tree</h3>
            <p><strong>â€¢ æœå°‹è¦å‰‡</strong><br>é€™å€‹éŠæˆ²å®Œç¾æ¨¡æ“¬äº†ã€ŒäºŒå…ƒæœå°‹æ¨¹ã€çš„æŸ¥æ‰¾éç¨‹ã€‚å®ƒçš„æ ¸å¿ƒè¦å‰‡æ˜¯ï¼š</p>
            <p><strong>å·¦å­ç¯€é» < çˆ¶ç¯€é» < å³å­ç¯€é»</strong></p>
            <p><strong>â€¢ æ•ˆç‡</strong><br>å› ç‚ºæ¯æ¬¡é¸æ“‡éƒ½èƒ½æ’é™¤ä¸€åŠçš„å¯èƒ½æ€§ï¼Œæ‰€ä»¥æœå°‹æ•ˆç‡æ¥µé«˜ï¼Œæ™‚é–“è¤‡é›œåº¦ç‚º O(log n)ã€‚</p>
        </div>
    </div>

    <!-- ä¸­é–“éŠæˆ²å€ -->
    <div class="game-area">
        <div class="game-header">
            <h1>ğŸŒ‰ ç»ç’ƒæ©‹æŒ‘æˆ°</h1>
            <p>åœ¨äºŒå…ƒæ¨¹çš„æ©‹ä¸Šï¼Œæ‰¾åˆ°é€šå¾€çµ‚é»çš„å”¯ä¸€é“è·¯</p>
        </div>
        <div class="target-box">ç›®æ¨™è™Ÿç¢¼: <span id="target-value">?</span></div>
        <div id="tree-container" class="tree-container"></div>
        <button id="start-btn" class="btn">é–‹å§‹æŒ‘æˆ°</button>
    </div>

    <!-- å³å´ï¼šç‹€æ…‹ -->
    <div class="tasks-panel">
        <div class="status-box">
            <h3>ğŸ“Š éŠæˆ²ç‹€æ…‹</h3>
            <div id="game-status"><p>éŠæˆ²å°šæœªé–‹å§‹</p></div>
        </div>
        <div class="history-box">
            <h3>ğŸ“‹ æ“ä½œè¨˜éŒ„</h3>
            <div id="history"><p style="color: #666; text-align: center;">é‚„æ²’æœ‰è¨˜éŒ„</p></div>
        </div>
    </div>
</div>

<!-- éé—œé é¢ -->
<div class="modal-overlay" id="end-game-modal">
    <div class="modal-content">
        <h2 id="modal-title">æŒ‘æˆ°å¤±æ•—</h2>
        <p>ä½ çš„æœ€çµ‚åˆ†æ•¸æ˜¯: <span class="final-score" id="final-score">0</span></p>
        <div class="modal-buttons">
            <button class="btn btn-replay" id="replay-btn">é‡æ–°æŒ‘æˆ°</button>
            <a href="graph-game.html" class="btn btn-next" id="next-level-btn">å‰å¾€ä¸‹ä¸€é—œ</a>
        </div>
    </div>
</div>

<script>
    // DOM Elements
    const treeContainer = document.getElementById('tree-container');
    const startBtn = document.getElementById('start-btn');
    const targetValueDisplay = document.getElementById('target-value');
    const gameStatus = document.getElementById('game-status');
    const historyLog = document.getElementById('history');
    const endGameModal = document.getElementById('end-game-modal');
    const modalTitle = document.getElementById('modal-title');
    const finalScoreDisplay = document.getElementById('final-score');
    const replayBtn = document.getElementById('replay-btn');
    const nextLevelBtn = document.getElementById('next-level-btn');

    // Game State
    let isPlaying = false;
    let tree = null;
    let targetValue = null;
    let currentNode = null;
    let score = 0;

    // --- Tree Node Class ---
    class TreeNode {
        constructor(value, level, x, y) {
            this.value = value;
            this.left = null;
            this.right = null;
            this.level = level;
            this.x = x;
            this.y = y;
            this.element = null;
        }
    }

    // --- Game Logic ---
    function generateBST(nodeCount) {
        const values = new Set();
        while (values.size < nodeCount) {
            values.add(Math.floor(Math.random() * 100));
        }
        const sortedValues = Array.from(values).sort((a, b) => a - b);

        function buildTree(arr, level, x, y, horizontalGap) {
            if (!arr.length) return null;
            const midIndex = Math.floor(arr.length / 2);
            const node = new TreeNode(arr[midIndex], level, x, y);
            node.left = buildTree(arr.slice(0, midIndex), level + 1, x - horizontalGap, y + 100, horizontalGap / 2);
            node.right = buildTree(arr.slice(midIndex + 1), level + 1, x + horizontalGap, y + 100, horizontalGap / 2);
            return node;
        }

        return buildTree(sortedValues, 0, treeContainer.offsetWidth / 2, 50, treeContainer.offsetWidth / 4);
    }

    function renderTree(node) {
        if (!node) return;

        if (node.left) {
            const line = document.createElement('div');
            line.className = 'tree-line';
            const x1 = node.x, y1 = node.y, x2 = node.left.x, y2 = node.left.y;
            const length = Math.sqrt((x2 - x1)**2 + (y2 - y1)**2);
            const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
            line.style.width = `${length}px`;
            line.style.height = '2px';
            line.style.left = `${x1}px`;
            line.style.top = `${y1 + 40}px`;
            line.style.transform = `rotate(${angle}deg)`;
            treeContainer.appendChild(line);
        }
        if (node.right) {
            const line = document.createElement('div');
            line.className = 'tree-line';
            const x1 = node.x, y1 = node.y, x2 = node.right.x, y2 = node.right.y;
            const length = Math.sqrt((x2 - x1)**2 + (y2 - y1)**2);
            const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
            line.style.width = `${length}px`;
            line.style.height = '2px';
            line.style.left = `${x1}px`;
            line.style.top = `${y1 + 40}px`;
            line.style.transform = `rotate(${angle}deg)`;
            treeContainer.appendChild(line);
        }

        const nodeDiv = document.createElement('div');
        nodeDiv.className = 'tree-node';
        nodeDiv.textContent = node.value;
        nodeDiv.style.left = `${node.x - 40}px`;
        nodeDiv.style.top = `${node.y}px`;
        node.element = nodeDiv;
        // â–¼â–¼â–¼ æ–°å¢é»æ“Šäº‹ä»¶ç›£è½ â–¼â–¼â–¼
        nodeDiv.addEventListener('click', () => handleNodeClick(node));
        treeContainer.appendChild(nodeDiv);

        renderTree(node.left);
        renderTree(node.right);
    }

    function addHistory(message, type) {
        if (historyLog.querySelector('p[style*="color: #666"]')) {
            historyLog.innerHTML = '';
        }
        const p = document.createElement('p');
        p.textContent = message;
        if (type === 'success') p.style.color = 'var(--squid-green)';
        else if (type === 'error') p.style.color = 'var(--squid-pink)';
        else p.style.color = '#ddd';
        historyLog.prepend(p);
    }

    // â–¼â–¼â–¼ å°‡æ ¸å¿ƒé‚è¼¯æŠ½å–æˆä¸€å€‹ç¨ç«‹å‡½å¼ â–¼â–¼â–¼
    function processMove(isLeftMove, moveType = 'éµç›¤') {
        const moveDescription = moveType === 'é»æ“Š' ? `é»æ“Šäº†` : `æŒ‰ä¸‹`;
        addHistory(`åœ¨ç¯€é» [${currentNode.value}] ${moveDescription} ${isLeftMove ? 'â† (å·¦)' : 'â†’ (å³)'}`, 'info');

        const correctMoveIsLeft = targetValue < currentNode.value;

        if (isLeftMove === correctMoveIsLeft) {
            // èµ°å°äº†
            const chosenNode = isLeftMove ? currentNode.left : currentNode.right;
            score += 100;
            currentNode.element.classList.add('path');
            currentNode = chosenNode;
            updateCurrentNode();
            addHistory(`é¸æ“‡æ­£ç¢ºï¼å‰å¾€ç¯€é» [${currentNode.value}]`, 'success');

            if (currentNode.value === targetValue) {
                currentNode.element.classList.add('path');
                endGame(true);
            }
        } else {
            // èµ°éŒ¯äº†
            addHistory(`é¸æ“‡éŒ¯èª¤ï¼ç»ç’ƒç¢è£‚ï¼`, 'error');
            const attemptedNode = isLeftMove ? currentNode.left : currentNode.right;
            if (attemptedNode && attemptedNode.element) {
                attemptedNode.element.classList.add('broken');
            }
            endGame(false);
        }
    }

    // éµç›¤äº‹ä»¶è™•ç†
    function handleKeyPress(e) {
        if (!isPlaying || (e.key !== 'ArrowLeft' && e.key !== 'ArrowRight')) return;
        processMove(e.key === 'ArrowLeft', 'éµç›¤');
    }

    // â–¼â–¼â–¼ æ–°å¢æ»‘é¼ é»æ“Šè™•ç†å‡½å¼ â–¼â–¼â–¼
    function handleNodeClick(clickedNode) {
        if (!isPlaying || !currentNode) return;

        const isLeftChild = (currentNode.left === clickedNode);
        const isRightChild = (currentNode.right === clickedNode);

        // å¦‚æœé»æ“Šçš„ä¸æ˜¯ç•¶å‰ç¯€é»çš„ç›´æ¥å­ç¯€é»ï¼Œå‰‡ä¸åæ‡‰
        if (!isLeftChild && !isRightChild) return;

        processMove(isLeftChild, 'é»æ“Š');
    }

    // æ›´æ–°ç•¶å‰ç¯€é»çš„æ¨£å¼ï¼Œä¸¦æ¨™ç¤ºå‡ºå¯é»æ“Šçš„å­ç¯€é»
    function updateCurrentNode() {
        document.querySelectorAll('.tree-node').forEach(el => {
            el.classList.remove('current');
            el.classList.remove('clickable'); // ç§»é™¤æ‰€æœ‰ç¯€é»çš„å¯é»æ“Šæ¨£å¼
        });
        if(currentNode && currentNode.element) {
            currentNode.element.classList.add('current');
            // ç‚ºç•¶å‰ç¯€é»çš„å­ç¯€é»åŠ ä¸Šå¯é»æ“Šçš„è¦–è¦ºæç¤º
            if (currentNode.left && currentNode.left.element) {
                currentNode.left.element.classList.add('clickable');
            }
            if (currentNode.right && currentNode.right.element) {
                currentNode.right.element.classList.add('clickable');
            }
        }
    }

    function initGame() {
        const nodeCount = 11; // Set to medium difficulty
        treeContainer.innerHTML = '';

        tree = generateBST(nodeCount);
        const allValues = [];
        function traverse(node) {
            if (!node) return;
            allValues.push(node.value);
            traverse(node.left);
            traverse(node.right);
        }
        traverse(tree);

        targetValue = allValues[Math.floor(Math.random() * allValues.length)];
        targetValueDisplay.textContent = String(targetValue);

        renderTree(tree);
        startBtn.style.display = 'block';
        startBtn.textContent = 'é–‹å§‹æŒ‘æˆ°';
        gameStatus.innerHTML = '<p>æº–å‚™å°±ç·’ï¼Œé»æ“ŠæŒ‰éˆ•é–‹å§‹ï¼</p>';
        historyLog.innerHTML = '<p style="color: #666; text-align: center;">é‚„æ²’æœ‰è¨˜éŒ„</p>';
    }

    function startGame() {
        isPlaying = true;
        score = 0;
        currentNode = tree;
        updateCurrentNode();

        startBtn.style.display = 'none';
        gameStatus.innerHTML = '<p style="color: var(--squid-green);">éŠæˆ²é€²è¡Œä¸­...</p>';
        historyLog.innerHTML = `<p style="color: #666; text-align: center;">è«‹ä½¿ç”¨æ–¹å‘éµæˆ–æ»‘é¼ é»æ“Š</p>`;

        document.addEventListener('keydown', handleKeyPress);
    }

    function endGame(isWin) {
        isPlaying = false;
        document.removeEventListener('keydown', handleKeyPress);
        // éŠæˆ²çµæŸæ™‚ç§»é™¤æ‰€æœ‰å¯é»æ“Šæç¤º
        document.querySelectorAll('.tree-node').forEach(el => el.classList.remove('clickable'));

        startBtn.style.display = 'block';
        startBtn.textContent = 'é‡æ–°æŒ‘æˆ°';

        if (isWin) {
            modalTitle.textContent = 'æŒ‘æˆ°æˆåŠŸï¼';
            finalScoreDisplay.textContent = String(score + 500); // æˆåŠŸåŠ åˆ†
            nextLevelBtn.style.display = 'inline-block';
            gameStatus.innerHTML = `<p style="color: var(--squid-green);">æŒ‘æˆ°æˆåŠŸï¼</p>`;
            addHistory(`ğŸ‰ æ­å–œï¼æ‰¾åˆ°ç›®æ¨™ ${targetValue}ï¼`, 'success');
        } else {
            modalTitle.textContent = 'æŒ‘æˆ°å¤±æ•—ï¼';
            finalScoreDisplay.textContent = String(score);
            nextLevelBtn.style.display = 'none';
            gameStatus.innerHTML = `<p style="color: #ff0000;">æŒ‘æˆ°å¤±æ•—ï¼</p>`;
            addHistory(`ğŸ’¥ æŒ‘æˆ°å¤±æ•—...`, 'error');
        }
        endGameModal.style.display = 'flex';
    }

    // Initial setup
    document.getElementById('start-btn').addEventListener('click', () => {
        if (!tree) {
            initGame();
        }
        startGame();
    });

    replayBtn.addEventListener('click', () => {
        endGameModal.style.display = 'none';
        initGame();
        startGame();
    });
</script>
</body>
</html>