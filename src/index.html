<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡æ–™çµæ§‹å°é…’é¤¨</title>
    <style>
        /* --- 1. åŸºæœ¬èˆ‡ä½ˆå±€ (Layout) --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: #f7f9fc;
            color: #333;
            display: grid;
            grid-template-columns: 260px 1fr; /* å·¦å´å°è¦½åˆ— 260pxï¼Œå³å´å…§å®¹å¡«æ»¿ */
            height: 100vh;
        }

        /* --- 2. å·¦å´å°è¦½åˆ— (Sidebar) --- */
        nav.sidebar {
            background-color: #eef1f6;
            padding: 2rem 0;
            border-right: 1px solid #dcdfe6;
            overflow-y: auto;
        }

        nav.sidebar h2 {
            font-size: 1.2rem;
            font-weight: 600;
            padding: 0 1.5rem;
            margin-bottom: 1rem;
            color: #0052cc; /* é¡ä¼¼ Swift çš„è—è‰² */
        }

        nav.sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        nav.sidebar li a {
            display: block;
            padding: 0.75rem 1.5rem 0.75rem 2.5rem; /* å¢åŠ å…§ç¸® */
            text-decoration: none;
            color: #495057;
            font-weight: 500;
            border-left: 4px solid transparent;
            transition: all 0.2s ease;
        }

        nav.sidebar li a:hover {
            background-color: #dfe6f0;
        }

        /* ç•¶å‰é¸ä¸­çš„é é¢æ¨£å¼ */
        nav.sidebar li a.active {
            color: #007aff;
            font-weight: 600;
            background-color: #fff;
            border-left-color: #007aff;
        }

        /* --- 3. å³å´å…§å®¹å€ (Main Content) --- */
        main.content {
            padding: 2.5rem;
            overflow-y: auto;
        }

        /* å…§å®¹é é¢é è¨­éš±è— */
        .page {
            display: none;
        }

        /* ç•¶å‰é¡¯ç¤ºçš„é é¢ */
        .page.active {
            display: block;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-top: 0;
            margin-bottom: 2rem;
        }

        p.intro {
            font-size: 1.1rem;
            color: #555;
            max-width: 700px;
            line-height: 1.6;
        }

        /* --- 4. é¦–é å¡ç‰‡ (Playground-style Cards) --- */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .card {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.07);
            padding: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            border-top: 5px solid;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.3rem;
        }

        .card p {
            font-size: 0.95rem;
            color: #666;
            line-height: 1.5;
        }

        /* ç‚ºå¡ç‰‡æŒ‡å®šä¸»é¡Œè‰² */
        .card[data-page="page-queue"] { border-color: #007aff; } /* è—è‰² */
        .card[data-page="page-bubble"] { border-color: #ff9500; } /* æ©˜è‰² */
        .card[data-page="page-list"] { border-color: #34c759; } /* ç¶ è‰² */
        .card[data-page="page-tree"] { border-color: #af52de; } /* ç´«è‰² */


        /* --- 5. ä½‡åˆ—éŠæˆ² (Queue Game) å°ˆç”¨æ¨£å¼ --- */
        .game-container {
            background: #fff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-top: 2rem;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 1.5rem;
        }

        .controls input {
            flex-grow: 1;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
        }

        .controls button {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #enqueue-btn {
            background-color: #007aff;
            color: white;
        }
        #enqueue-btn:hover { background-color: #005ecb; }

        #dequeue-btn {
            background-color: #e5e5ea;
            color: #333;
        }
        #dequeue-btn:hover { background-color: #dcdcdc; }

        .queue-label {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            color: #555;
            padding: 0 10px;
        }

        /* ä½‡åˆ—è¦–è¦º (è¼¸é€å¸¶) */
        .queue-belt {
            background: #f4f4f4;
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 1rem;
            min-height: 80px;
            display: flex;
            align-items: center;
            overflow-x: auto;
        }

        /* ä½‡åˆ—ä¸­çš„é …ç›® (é¤é») */
        .queue-item {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); /* æ©˜é»ƒæ¼¸å±¤ */
            color: #fff;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1.1rem;
            margin-right: 10px;
            flex-shrink: 0; /* ç¢ºä¿é …ç›®ä¸æœƒè¢«å£“ç¸® */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .learning-guide {
            background-color: #eef1f6;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
            line-height: 1.7;
        }
        .learning-guide h3 {
            margin-top: 0;
            color: #0052cc;
        }
        .learning-guide ul {
            padding-left: 20px;
        }
        .learning-guide code {
            background-color: #dfe6f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: "SF Mono", "Fira Code", monospace;
        }

        /* --- 6. Toast é€šçŸ¥ç³»çµ± --- */
        .toast-container {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 250px;
            animation: slide-in-right 0.3s ease-out;
        }

        .toast.success { border-left: 4px solid #34c759; }
        .toast.error { border-left: 4px solid #ff3b30; }
        .toast.info { border-left: 4px solid #007aff; }
        .toast.warning { border-left: 4px solid #ff9500; }

        .toast-icon {
            font-size: 1.2rem;
        }

        .toast-message {
            flex: 1;
            font-size: 0.95rem;
        }

        /* --- 7. å‹•ç•«æ•ˆæœ --- */
        @keyframes slide-in-right {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse-highlight {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(0, 122, 255, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(0, 122, 255, 0);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .pulse-highlight {
            animation: pulse-highlight 1s ease-out;
        }

        .shake {
            animation: shake 0.3s ease-out;
        }

        .error-input {
            border-color: #ff3b30 !important;
            box-shadow: 0 0 0 3px rgba(255, 59, 48, 0.1);
        }

        /* --- 8. Tooltip --- */
        .tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
            white-space: nowrap;
            z-index: 10000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tooltip.show {
            opacity: 1;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            border: 5px solid transparent;
        }

        .tooltip.top::after {
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-top-color: #333;
        }

        /* --- 9. æ“ä½œæŒ‡å¼•é¢æ¿ --- */
        .instruction-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .instruction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .instruction-header h3 {
            margin: 0;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .reset-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .reset-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-fill {
            background: white;
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .instruction-steps {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .step.completed {
            background: rgba(52, 199, 89, 0.2);
        }

        .step.active {
            background: rgba(255, 255, 255, 0.25);
            font-weight: 600;
            transform: scale(1.02);
        }

        .step.pending {
            opacity: 0.6;
        }

        .step-icon {
            font-size: 1.2rem;
            min-width: 24px;
            text-align: center;
        }

        .step.completed .step-icon::before {
            content: 'âœ“';
        }

        .step.active .step-icon::before {
            content: 'â–¶';
            animation: pulse 1.5s infinite;
        }

        .step.pending .step-icon::before {
            content: 'â—‹';
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .step-text {
            flex: 1;
        }

        .concept-explanation {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .expand-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            width: 100%;
            text-align: left;
            transition: background 0.2s;
        }

        .expand-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .explanation-content {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            font-size: 0.9rem;
            line-height: 1.6;
            display: none;
        }

        .explanation-content.show {
            display: block;
        }

    </style>
</head>
<body>

<nav class="sidebar">
    <h2>è³‡æ–™çµæ§‹å°é…’é¤¨</h2>
    <ul>
        <li><a href="#" class="nav-link active" data-page="page-home">ğŸ  é¦–é </a></li>
        <li><a href="#" class="nav-link" data-page="page-queue">ğŸ” ä½‡åˆ— (Queue)</a></li>
        <li><a href="#" class="nav-link" data-page="page-bubble">ğŸ¥‚ æ°£æ³¡æ’åºæ³•</a></li>
        <li><a href="#" class="nav-link" data-page="page-list">ğŸ§¾ é›™å‘é€£çµä¸²åˆ—</a></li>
        <li><a href="#" class="nav-link" data-page="page-tree">ğŸŒ³ æ¨¹ç‹€çµæ§‹</a></li>
    </ul>
</nav>

<main class="content">

    <section id="page-home" class="page active">
        <h1>æ­¡è¿ä¾†åˆ°è³‡æ–™çµæ§‹å°é…’é¤¨ï¼</h1>
        <p class="intro">
            åœ¨é€™è£¡ï¼Œæˆ‘å€‘ä¸è«‡ç”Ÿç¡¬çš„ç†è«–ã€‚æ‚¨å°‡æ‰®æ¼”å°é…’é¤¨çš„å¯¦ç¿’ç”Ÿï¼Œ
            é€éå®Œæˆä¸€ç³»åˆ—çš„ã€ŒéŠæˆ²é—œå¡ã€ï¼Œåœ¨ç©æ¨‚ä¸­å­¸æœƒæœ€é‡è¦çš„è³‡æ–™çµæ§‹èˆ‡æ¼”ç®—æ³•ã€‚
        </p>

        <div class="card-grid">
            <div class="card" data-page="page-queue">
                <h3>ğŸ” é—œå¡ 1: å§å°å‡ºé¤å€</h3>
                <p>å­¸ç¿’ã€Œä½‡åˆ— (Queue)ã€çš„å…ˆé€²å…ˆå‡º (FIFO) åŸå‰‡ï¼Œç¢ºä¿é¤é»ä¾ç…§æ­£ç¢ºé †åºé€å‡ºï¼</p>
            </div>
            <div class="card" data-page="page-bubble">
                <h3>ğŸ¥‚ é—œå¡ 2: é…’æ¯æ•´ç†æ¶</h3>
                <p>å­¸ç¿’ã€Œæ°£æ³¡æ’åºæ³•ã€ï¼Œå°‡å§æª¯ä¸Šé›œäº‚çš„é…’æ¯ç”±çŸ®åˆ°é«˜ä¸€ä¸€æ’å¥½ã€‚</p>
            </div>
            <div class="card" data-page="page-list">
                <h3>ğŸ§¾ é—œå¡ 3: VIP è¨‚ä½è¡¨</h3>
                <p>å­¸ç¿’ã€Œé›™å‘é€£çµä¸²åˆ—ã€ï¼Œå½ˆæ€§åœ°åœ¨è¨‚ä½è¡¨ä¸­æ’å…¥æˆ–åˆªé™¤ VIP é¡§å®¢ã€‚</p>
            </div>
            <div class="card" data-page="page-tree">
                <h3>ğŸŒ³ é—œå¡ 4: èœå–®åˆ†é¡ç³»çµ±</h3>
                <p>å­¸ç¿’ã€Œæ¨¹ç‹€çµæ§‹ã€ï¼Œè¨­è¨ˆä¸€ä»½æœ‰å±¤æ¬¡ã€æ˜“æ–¼ç€è¦½çš„é¤å»³èœå–®ã€‚</p>
            </div>
        </div>
    </section>

    <section id="page-queue" class="page">
        <h1>ğŸ” é—œå¡ 1: å§å°å‡ºé¤å€ (ä½‡åˆ—)</h1>
        <p class="intro">å»šæˆ¿åšå¥½äº†é¤é»ï¼æˆ‘å€‘çš„ä»»å‹™æ˜¯é€éè¼¸é€å¸¶ï¼Œç¢ºä¿é¤é»èƒ½ã€Œå…ˆé€²å…ˆå‡ºã€ï¼Œæ­£ç¢ºåœ°é€åˆ°é¡§å®¢æ‰‹ä¸­ã€‚</p>

        <!-- æ“ä½œæŒ‡å¼•é¢æ¿ -->
        <div class="instruction-panel" id="queue-instructions">
            <div class="instruction-header">
                <h3>ğŸ“‹ ä»»å‹™æŒ‡å¼•</h3>
                <button class="reset-btn" id="reset-btn">ğŸ”„ é‡ç½®</button>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>

            <ol class="instruction-steps" id="instruction-steps">
                <!-- æ­¥é©Ÿæœƒç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </ol>

            <div class="concept-explanation">
                <button class="expand-btn" id="expand-btn">ğŸ’¡ ç‚ºä»€éº¼é€™æ¨£åšï¼Ÿ</button>
                <div class="explanation-content" id="explanation-content">
                    é€™å€‹å‹•ä½œå«åš <strong>Enqueueï¼ˆå…¥éšŠï¼‰</strong>ï¼ŒæœƒæŠŠæ–°å…ƒç´ åŠ åˆ°ä½‡åˆ—çš„å°¾ç«¯ã€‚
                    ä½‡åˆ—éµå¾ª FIFOï¼ˆå…ˆé€²å…ˆå‡ºï¼‰åŸå‰‡ï¼Œå°±åƒæ’éšŠè²·ç¥¨ä¸€æ¨£ï¼Œå…ˆåˆ°çš„äººå…ˆæœå‹™ï¼
                    æ™‚é–“è¤‡é›œåº¦ï¼šO(1) - è¡¨ç¤ºç„¡è«–ä½‡åˆ—æœ‰å¤šé•·ï¼ŒåŠ å…¥æ–°å…ƒç´ çš„æ™‚é–“éƒ½æ˜¯å›ºå®šçš„ã€‚
                </div>
            </div>
        </div>

        <div class="learning-guide">
            <h3>1. ä»€éº¼æ˜¯ä½‡åˆ— (Queue)ï¼Ÿ</h3>
            <p>
                æƒ³åƒä¸€ä¸‹åœ¨å’–å•¡åº—æ’éšŠï¼šå…ˆä¾†çš„äººæœƒå…ˆé»é¤ï¼Œæ–°ä¾†çš„å®¢äººå¿…é ˆæ’åœ¨éšŠä¼çš„æœ€å¾Œé¢ã€‚é€™å°±æ˜¯ã€Œä½‡åˆ—ã€çš„æ ¸å¿ƒç²¾ç¥ï¼š<b>å…ˆé€²å…ˆå‡º (First-In, First-Out, FIFO)</b>ã€‚
            </p>

            <h3>2. å¦‚ä½•ç©é€™å€‹éŠæˆ²ï¼Ÿ</h3>
            <p>åœ¨é€™å€‹éŠæˆ²ä¸­ï¼Œã€Œè¼¸é€å¸¶ã€å°±æ˜¯æˆ‘å€‘çš„ä½‡åˆ—ï¼š</p>
            <ul>
                <li><b>æ”¾åˆ°è¼¸é€å¸¶ (Enqueue)</b>ï¼šå°‡æ–°çš„é¤é»æ”¾åˆ°è¼¸é€å¸¶çš„ã€Œå°¾ç«¯ã€ã€‚</li>
                <li><b>å–é¤çµ¦é¡§å®¢ (Dequeue)</b>ï¼šå¾è¼¸é€å¸¶çš„ã€Œå‰ç«¯ã€å–èµ°æœ€æ—©æ”¾ä¸Šå»çš„é¤é»ã€‚</li>
            </ul>

            <p><b>è«‹ä½ è©¦è©¦çœ‹ï¼š</b></p>
            <ol>
                <li>åœ¨è¼¸å…¥æ¡†ä¸­è¼¸å…¥ã€Œæ¼¢å ¡ã€ï¼ŒæŒ‰ä¸‹ <code>æ”¾åˆ°è¼¸é€å¸¶</code>ã€‚</li>
                <li>æ¥è‘—è¼¸å…¥ã€Œè–¯æ¢ã€ï¼Œå†æŒ‰ä¸€æ¬¡ã€‚</li>
                <li>ä½ æœƒçœ‹åˆ°è¼¸é€å¸¶ä¸Šé¤é»çš„é †åºæ˜¯ï¼š æ¼¢å ¡ â†’ è–¯æ¢ã€‚</li>
                <li>ç¾åœ¨ï¼ŒæŒ‰ä¸‹ <code>å–é¤çµ¦é¡§å®¢</code>ï¼Œæœ€å…ˆé€²ä¾†çš„ã€Œæ¼¢å ¡ã€æœƒè¢«å…ˆå–èµ°ã€‚</li>
            </ol>
            <p>
                é€™å€‹éŠæˆ²å®Œç¾å±•ç¤ºäº†ä½‡åˆ—ã€Œå…ˆé€²å…ˆå‡ºã€çš„ç‰¹æ€§ã€‚åœ¨ç¨‹å¼è¨­è¨ˆä¸­ï¼Œä½‡åˆ—å¸¸ç”¨æ–¼è™•ç†éœ€è¦ä¾åºè™•ç†çš„ä»»å‹™ï¼Œä¾‹å¦‚è™•ç†ç¶²è·¯è«‹æ±‚ã€ç®¡ç†å°è¡¨æ©Ÿçš„å·¥ä½œæ’ç¨‹ç­‰ã€‚
            </p>
        </div>

        <div class="game-container">
            <h3>éŠæˆ²æ§åˆ¶</h3>
            <div class="controls">
                <input type="text" id="item-input" placeholder="è¼¸å…¥é¤é»åç¨± (ä¾‹å¦‚: æ¼¢å ¡)">
                <button id="enqueue-btn">æ”¾åˆ°è¼¸é€å¸¶ (Enqueue)</button>
                <button id="dequeue-btn">å–é¤çµ¦é¡§å®¢ (Dequeue)</button>
            </div>

            <hr style="border: 0; border-top: 1px solid #eee; margin: 2rem 0;">

            <h3>è¼¸é€å¸¶ (ä½‡åˆ—æœ¬é«”)</h3>
            <div class="queue-label">
                <span id="label-front">â¡ï¸ å‰ç«¯ (Front) - å¾é€™è£¡å–é¤</span>
                <span id="label-rear">â¬…ï¸ å°¾ç«¯ (Rear) - å¾é€™è£¡æ”¾é¤</span>
            </div>
            <div class="queue-belt" id="queue-visual">
            </div>
        </div>
    </section>

    <section id="page-bubble" class="page">
        <h1>ğŸ¥‚ é—œå¡ 2: é…’æ¯æ•´ç†æ¶ (æ°£æ³¡æ’åºæ³•)</h1>
        <p class="intro">é€™å€‹é—œå¡æ­£åœ¨æº–å‚™ä¸­ï¼æ•¬è«‹æœŸå¾…ã€‚</p>
    </section>

    <section id="page-list" class="page">
        <h1>ğŸ§¾ é—œå¡ 3: VIP è¨‚ä½è¡¨ (é›™å‘é€£çµä¸²åˆ—)</h1>
        <p class="intro">é€™å€‹é—œå¡æ­£åœ¨æº–å‚™ä¸­ï¼æ•¬è«‹æœŸå¾…ã€‚</p>
    </section>

    <section id="page-tree" class="page">
        <h1>ğŸŒ³ é—œå¡ 4: èœå–®åˆ†é¡ç³»çµ± (æ¨¹ç‹€çµæ§‹)</h1>
        <p class="intro">é€™å€‹é—œå¡æ­£åœ¨æº–å‚™ä¸­ï¼æ•¬è«‹æœŸå¾…ã€‚</p>
    </section>

</main>

<script>
    // ===== Core Classes =====

    // FeedbackEngine: è™•ç†æ‰€æœ‰è¦–è¦ºå›é¥‹
    class FeedbackEngine {
        constructor() {
            this.toastContainer = null;
            this.initToastContainer();
        }

        initToastContainer() {
            this.toastContainer = document.createElement('div');
            this.toastContainer.className = 'toast-container';
            document.body.appendChild(this.toastContainer);
        }

        showToast(message, type = 'success', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: 'âœ“',
                error: 'âœ—',
                info: 'â„¹',
                warning: 'âš '
            };

            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <span class="toast-message">${message}</span>
            `;

            this.toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        highlightElement(selector, duration = 1000) {
            const element = document.querySelector(selector);
            if (!element) return;

            element.classList.add('pulse-highlight');
            setTimeout(() => {
                element.classList.remove('pulse-highlight');
            }, duration);
        }

        showTooltip(element, message, position = 'top') {
            const tooltip = document.createElement('div');
            tooltip.className = `tooltip ${position}`;
            tooltip.textContent = message;
            document.body.appendChild(tooltip);

            const rect = element.getBoundingClientRect();
            tooltip.style.left = rect.left + rect.width / 2 - tooltip.offsetWidth / 2 + 'px';
            tooltip.style.top = rect.top - tooltip.offsetHeight - 10 + 'px';

            setTimeout(() => tooltip.classList.add('show'), 10);

            setTimeout(() => {
                tooltip.classList.remove('show');
                setTimeout(() => tooltip.remove(), 200);
            }, 2000);
        }

        animateAction(element, animationType) {
            if (typeof element === 'string') {
                element = document.querySelector(element);
            }
            if (!element) return;

            element.classList.add(animationType);
            setTimeout(() => {
                element.classList.remove(animationType);
            }, 300);
        }

        showErrorHint(inputElement, message) {
            if (typeof inputElement === 'string') {
                inputElement = document.querySelector(inputElement);
            }
            if (!inputElement) return;

            inputElement.classList.add('error-input');
            this.animateAction(inputElement, 'shake');
            this.showTooltip(inputElement, message, 'top');

            setTimeout(() => {
                inputElement.classList.remove('error-input');
            }, 2000);

            inputElement.focus();
        }
    }

    // ErrorHandler: è™•ç†éŒ¯èª¤ä¸¦æä¾›å‹å–„æç¤º
    class ErrorHandler {
        constructor(feedbackEngine) {
            this.feedbackEngine = feedbackEngine;
        }

        handleEmptyInput() {
            const input = document.getElementById('item-input');
            this.feedbackEngine.showErrorHint(input, 'è«‹è¼¸å…¥é¤é»åç¨±ï¼è©¦è©¦ã€Œæ¼¢å ¡ã€æˆ–ã€Œè–¯æ¢ã€');
        }

        handleEmptyQueue() {
            const dequeueBtn = document.getElementById('dequeue-btn');
            this.feedbackEngine.animateAction(dequeueBtn, 'shake');
            this.feedbackEngine.showToast('è¼¸é€å¸¶æ˜¯ç©ºçš„ï¼è«‹å…ˆåŠ å…¥ä¸€äº›é¤é»', 'error');

            // å¼•å°ä½¿ç”¨è€…åˆ°æ­£ç¢ºçš„æ“ä½œ
            const enqueueBtn = document.getElementById('enqueue-btn');
            this.feedbackEngine.highlightElement('#enqueue-btn', 2000);
        }

        handleWrongAction(expectedAction, currentStep) {
            this.feedbackEngine.showToast(
                `é‚„æ²’åˆ°é€™ä¸€æ­¥å–”ï¼è«‹å…ˆå®Œæˆï¼š${currentStep.text}`,
                'info'
            );
        }
    }

    // InstructionPanel: é¡¯ç¤ºæ­¥é©ŸæŒ‡å¼•
    class InstructionPanel {
        constructor(containerId, steps) {
            this.container = document.getElementById(containerId);
            this.steps = steps;
            this.currentStepIndex = 0;
            this.render();
        }

        render() {
            const stepsContainer = document.getElementById('instruction-steps');
            if (!stepsContainer) return;

            stepsContainer.innerHTML = '';
            this.steps.forEach((step, index) => {
                const li = document.createElement('li');
                li.className = 'step';

                if (index < this.currentStepIndex) {
                    li.classList.add('completed');
                } else if (index === this.currentStepIndex) {
                    li.classList.add('active');
                } else {
                    li.classList.add('pending');
                }

                li.innerHTML = `
                    <span class="step-icon"></span>
                    <span class="step-text">${step.text}</span>
                `;

                stepsContainer.appendChild(li);
            });

            this.updateProgressBar();
        }

        updateProgressBar() {
            const progressFill = document.getElementById('progress-fill');
            if (!progressFill) return;

            const progress = (this.currentStepIndex / this.steps.length) * 100;
            progressFill.style.width = `${progress}%`;
        }

        nextStep() {
            if (this.currentStepIndex < this.steps.length) {
                this.currentStepIndex++;
                this.render();
            }
        }

        highlightStep(index) {
            this.currentStepIndex = index;
            this.render();
        }

        reset() {
            this.currentStepIndex = 0;
            this.render();
        }

        getCurrentStep() {
            return this.steps[this.currentStepIndex];
        }
    }

    // StateManager: é›†ä¸­ç®¡ç†æ‰€æœ‰ç‹€æ…‹
    class StateManager {
        constructor() {
            this.state = {
                currentModule: 'queue',
                currentStep: 0,
                completedSteps: [],
                queueData: [],
                practiceTasksCompleted: []
            };
            this.listeners = [];
        }

        setState(updates) {
            this.state = { ...this.state, ...updates };
            this.notifyListeners();
        }

        getState() {
            return this.state;
        }

        subscribe(listener) {
            this.listeners.push(listener);
        }

        notifyListeners() {
            this.listeners.forEach(listener => listener(this.state));
        }

        saveToLocalStorage() {
            try {
                localStorage.setItem('gameState', JSON.stringify(this.state));
            } catch (e) {
                console.warn('ç„¡æ³•å„²å­˜ç‹€æ…‹åˆ° localStorage');
            }
        }

        loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('gameState');
                if (saved) {
                    this.state = { ...this.state, ...JSON.parse(saved) };
                    this.notifyListeners();
                }
            } catch (e) {
                console.warn('ç„¡æ³•å¾ localStorage è¼‰å…¥ç‹€æ…‹');
            }
        }

        resetModule(moduleId) {
            this.setState({
                currentStep: 0,
                completedSteps: [],
                queueData: [],
                practiceTasksCompleted: []
            });
            this.saveToLocalStorage();
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // åˆå§‹åŒ–æ ¸å¿ƒç³»çµ±
        const stateManager = new StateManager();
        const feedbackEngine = new FeedbackEngine();
        const errorHandler = new ErrorHandler(feedbackEngine);
        stateManager.loadFromLocalStorage();

        // --- 1. é é¢åˆ‡æ›é‚è¼¯ ---
        const navLinks = document.querySelectorAll('.nav-link');
        const cards = document.querySelectorAll('.card');
        const pages = document.querySelectorAll('.page');

        function showPage(pageId) {
            // éš±è—æ‰€æœ‰é é¢
            pages.forEach(page => page.classList.remove('active'));

            // é¡¯ç¤ºç›®æ¨™é é¢
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            }

            // æ›´æ–°å°è¦½åˆ—çš„ active ç‹€æ…‹
            navLinks.forEach(link => {
                if (link.dataset.page === pageId) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }

        // å¹«å°è¦½åˆ—åŠ ä¸Šé»æ“Šäº‹ä»¶
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault(); // é˜²æ­¢é é¢è·³è½‰
                const pageId = e.target.dataset.page;
                showPage(pageId);
            });
        });

        // å¹«é¦–é å¡ç‰‡åŠ ä¸Šé»æ“Šäº‹ä»¶
        cards.forEach(card => {
            card.addEventListener('click', (e) => {
                const pageId = e.currentTarget.dataset.page;
                showPage(pageId);
            });
        });

        // --- 2. ä½‡åˆ— (Queue) éŠæˆ²é‚è¼¯ ---
        const enqueueBtn = document.getElementById('enqueue-btn');
        const dequeueBtn = document.getElementById('dequeue-btn');
        const itemInput = document.getElementById('item-input');
        const queueVisual = document.getElementById('queue-visual');

        // å®šç¾©ä½‡åˆ—éŠæˆ²çš„æ­¥é©Ÿ
        const queueSteps = [
            { id: 1, text: 'åœ¨è¼¸å…¥æ¡†è¼¸å…¥ã€Œæ¼¢å ¡ã€', action: 'input' },
            { id: 2, text: 'æŒ‰ä¸‹ã€Œæ”¾åˆ°è¼¸é€å¸¶ã€æŒ‰éˆ•', action: 'enqueue' },
            { id: 3, text: 'è§€å¯Ÿé¤é»å‡ºç¾åœ¨è¼¸é€å¸¶å°¾ç«¯', action: 'observe' },
            { id: 4, text: 'å†åŠ å…¥ã€Œè–¯æ¢ã€åˆ°è¼¸é€å¸¶', action: 'enqueue' },
            { id: 5, text: 'æŒ‰ä¸‹ã€Œå–é¤çµ¦é¡§å®¢ã€æŒ‰éˆ•', action: 'dequeue' },
            { id: 6, text: 'è§€å¯Ÿæœ€å…ˆåŠ å…¥çš„é¤é»è¢«å–èµ°', action: 'complete' }
        ];

        // åˆå§‹åŒ–æ“ä½œæŒ‡å¼•é¢æ¿
        let instructionPanel = null;
        if (document.getElementById('queue-instructions')) {
            instructionPanel = new InstructionPanel('queue-instructions', queueSteps);
        }

        // å±•é–‹/æ”¶åˆèªªæ˜æŒ‰éˆ•
        const expandBtn = document.getElementById('expand-btn');
        const explanationContent = document.getElementById('explanation-content');
        if (expandBtn && explanationContent) {
            expandBtn.addEventListener('click', () => {
                explanationContent.classList.toggle('show');
                expandBtn.textContent = explanationContent.classList.contains('show')
                    ? 'ğŸ’¡ æ”¶èµ·èªªæ˜'
                    : 'ğŸ’¡ ç‚ºä»€éº¼é€™æ¨£åšï¼Ÿ';
            });
        }

        // é‡ç½®æŒ‰éˆ•
        const resetBtn = document.getElementById('reset-btn');
        if (resetBtn && instructionPanel) {
            resetBtn.addEventListener('click', () => {
                if (confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹å—ï¼Ÿ')) {
                    instructionPanel.reset();
                    queueVisual.innerHTML = '';
                    itemInput.value = '';
                    feedbackEngine.showToast('å·²é‡ç½®ï¼è®“æˆ‘å€‘é‡æ–°é–‹å§‹', 'info');
                }
            });
        }

        // Enqueue (å…¥éšŠ)
        enqueueBtn.addEventListener('click', () => {
            const itemName = itemInput.value.trim();
            if (itemName === "") {
                errorHandler.handleEmptyInput();
                return;
            }

            // å»ºç«‹ä¸€å€‹æ–°çš„ "é¤é»" div
            const newItem = document.createElement('div');
            newItem.classList.add('queue-item');
            newItem.textContent = itemName;

            // åŠ åˆ°è¼¸é€å¸¶ (ä½‡åˆ—) çš„å°¾ç«¯
            queueVisual.appendChild(newItem);

            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            feedbackEngine.showToast(`å¤ªæ£’äº†ï¼ã€Œ${itemName}ã€å·²åŠ å…¥è¼¸é€å¸¶`, 'success');

            // é«˜äº®å°¾ç«¯æ¨™ç±¤
            feedbackEngine.highlightElement('#label-rear', 1000);

            // æ¨é€²æ­¥é©Ÿ
            if (instructionPanel) {
                const currentStep = instructionPanel.getCurrentStep();
                if (currentStep && currentStep.action === 'enqueue') {
                    setTimeout(() => {
                        instructionPanel.nextStep();
                        if (instructionPanel.currentStepIndex < queueSteps.length) {
                            feedbackEngine.showToast('å¾ˆå¥½ï¼ç¹¼çºŒä¸‹ä¸€æ­¥', 'info', 2000);
                        }
                    }, 500);
                }
            }

            itemInput.value = ""; // æ¸…ç©ºè¼¸å…¥æ¡†
        });

        // Dequeue (å‡ºéšŠ)
        dequeueBtn.addEventListener('click', () => {
            // æª¢æŸ¥è¼¸é€å¸¶ä¸Šæ˜¯å¦æœ‰é¤é»
            if (queueVisual.firstElementChild) {
                const itemName = queueVisual.firstElementChild.textContent;
                // ç§»é™¤ "ç¬¬ä¸€å€‹" (æœ€å‰é¢) çš„é¤é»
                queueVisual.firstElementChild.remove();
                feedbackEngine.showToast(`ã€Œ${itemName}ã€å·²é€çµ¦é¡§å®¢ï¼`, 'success');

                // é«˜äº®å‰ç«¯æ¨™ç±¤
                feedbackEngine.highlightElement('#label-front', 1000);

                // æ¨é€²æ­¥é©Ÿ
                if (instructionPanel) {
                    const currentStep = instructionPanel.getCurrentStep();
                    if (currentStep && currentStep.action === 'dequeue') {
                        setTimeout(() => {
                            instructionPanel.nextStep();
                            if (instructionPanel.currentStepIndex >= queueSteps.length) {
                                feedbackEngine.showToast('ğŸ‰ æ­å–œï¼ä½ å·²å®Œæˆä½‡åˆ—é—œå¡ï¼', 'success', 4000);
                            }
                        }, 500);
                    }
                }
            } else {
                errorHandler.handleEmptyQueue();
            }
        });

        // ç›£è½è¼¸å…¥æ¡†ï¼Œæ¨é€²æ­¥é©Ÿ
        if (itemInput && instructionPanel) {
            itemInput.addEventListener('input', () => {
                const currentStep = instructionPanel.getCurrentStep();
                if (currentStep && currentStep.action === 'input' && itemInput.value.trim().length > 0) {
                    setTimeout(() => {
                        instructionPanel.nextStep();
                        feedbackEngine.showToast('å¾ˆå¥½ï¼ç¾åœ¨æŒ‰ä¸‹æŒ‰éˆ•', 'info', 2000);
                    }, 300);
                }
            });
        }
    });
</script>

</body>
</html>